name: Deploy

on:
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°ë¡œë§Œ ë°°í¬ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      environment:
        description: "ë°°í¬ í™˜ê²½ ì„ íƒ"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging
      deploy_notes:
        description: "ë°°í¬ ë…¸íŠ¸ (ì„ íƒì‚¬í•­)"
        required: false
        type: string

jobs:
  # ğŸ” CI: ë°°í¬ ì „ ê²€ì‚¬ (PR + Push ëª¨ë‘ ì‹¤í–‰)
  ci:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          if ! npm ci; then
            echo ""
            echo "âŒ Dependency installation failed!"
            echo ""
            echo "ğŸ” Possible issues:"
            echo "   - package-lock.json out of sync"
            echo "   - Node.js version mismatch"
            echo "   - Network connectivity issues"
            echo ""
            echo "ğŸ’¡ Try locally:"
            echo "   rm -rf node_modules package-lock.json"
            echo "   npm install"
            exit 1
          else
            echo "âœ… Dependencies installed successfully!"
          fi

      - name: Run ESLint
        run: |
          echo "ğŸ” Running ESLint code quality checks..."
          if ! npm run lint; then
            echo ""
            echo "âŒ ESLint found code quality issues!"
            echo ""
            echo "ğŸ”§ To fix auto-fixable issues, run:"
            echo "   npm run lint:fix"
            echo ""
            echo "ğŸ“š ESLint rules documentation:"
            echo "   https://nextjs.org/docs/app/api-reference/config/eslint"
            exit 1
          else
            echo "âœ… No ESLint issues found!"
          fi

      - name: Check TypeScript
        run: |
          echo "ğŸ”§ Running TypeScript type checking..."
          if ! npm run type-check; then
            echo ""
            echo "âŒ TypeScript type errors found!"
            echo ""
            echo "ğŸ’¡ Common fixes:"
            echo "   - Check for missing type imports"
            echo "   - Verify interface definitions"
            echo "   - Add type annotations for parameters"
            echo ""
            echo "ğŸ“š TypeScript handbook:"
            echo "   https://www.typescriptlang.org/docs/"
            exit 1
          else
            echo "âœ… No TypeScript errors found!"
          fi

      - name: Check Prettier formatting
        run: |
          echo "ğŸ¨ Checking code formatting with Prettier..."
          if ! npm run format:check; then
            echo ""
            echo "âŒ Prettier formatting issues found!"
            echo ""
            echo "ğŸ“ Files with formatting issues:"
            npx prettier --check . --list-different || true
            echo ""
            echo "ğŸ” Detailed differences:"
            for file in $(npx prettier --check . --list-different 2>/dev/null || true); do
              echo "--- $file ---"
              npx prettier --check "$file" 2>&1 || true
              echo ""
            done
            echo ""
            echo "ğŸ”§ To fix these issues locally, run:"
            echo "   npm run format"
            echo ""
            echo "ğŸ“‹ Or fix specific files:"
            echo "   npx prettier --write <filename>"
            exit 1
          else
            echo "âœ… All files are properly formatted!"
          fi

      - name: Build verification
        run: |
          echo "ğŸ—ï¸ Building application for production..."
          if ! npm run build; then
            echo ""
            echo "âŒ Build failed!"
            echo ""
            echo "ğŸ” Common build issues:"
            echo "   - TypeScript errors in production build"
            echo "   - Missing environment variables"
            echo "   - Import/export syntax errors"
            echo "   - Tailwind CSS configuration issues"
            echo ""
            echo "ğŸ’¡ Try building locally first:"
            echo "   npm run build"
            exit 1
          else
            echo "âœ… Build completed successfully!"
            echo "ğŸ“¦ Production build is ready for deployment"
          fi
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NEXT_PUBLIC_STACK_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_STACK_PROJECT_ID }}
          NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY: ${{ secrets.NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY }}
          STACK_SECRET_SERVER_KEY: ${{ secrets.STACK_SECRET_SERVER_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}
          NEXT_PUBLIC_APP_NAME: ${{ secrets.NEXT_PUBLIC_APP_NAME || 'Dalian' }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}

      - name: Bundle size analysis
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          echo ""

          # .next í´ë” í¬ê¸° í™•ì¸
          if [ -d ".next" ]; then
            echo "ğŸ“¦ Build output analysis:"
            echo "   Total build size: $(du -sh .next | cut -f1)"
            echo "   Static files: $(du -sh .next/static 2>/dev/null | cut -f1 || echo 'N/A')"
            echo "   Server files: $(du -sh .next/server 2>/dev/null | cut -f1 || echo 'N/A')"
            echo ""
            
            # JavaScript ë²ˆë“¤ í¬ê¸° ë¶„ì„
            echo "ğŸ¯ JavaScript bundles:"
            find .next -name "*.js" -type f -exec ls -lh {} \; | awk '{print "   " $9 ": " $5}' | head -10
            echo ""
            
            # CSS íŒŒì¼ í¬ê¸°
            echo "ğŸ¨ CSS files:"
            find .next -name "*.css" -type f -exec ls -lh {} \; | awk '{print "   " $9 ": " $5}' | head -5
            echo ""
            
            # í° íŒŒì¼ë“¤ ê²½ê³ 
            echo "âš ï¸  Large files (>500KB):"
            find .next -type f -size +500k -exec ls -lh {} \; | awk '{print "   âš ï¸  " $9 ": " $5}' || echo "   âœ… No large files found"
            echo ""
            
            echo "ğŸ’¡ Bundle optimization tips:"
            echo "   - Use dynamic imports for large components"
            echo "   - Optimize images with next/image"
            echo "   - Remove unused dependencies"
            echo "   - Consider code splitting"
          else
            echo "âŒ Build output not found!"
          fi

  # ğŸš€ CD: ë°°í¬ (ìˆ˜ë™ íŠ¸ë¦¬ê±°ì‹œì—ë§Œ ì‹¤í–‰)
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    needs: ci
    # workflow_dispatchì—ì„œë§Œ ì‹¤í–‰
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        run: |
          echo "ğŸš€ Deploying to Vercel (${{ github.event.inputs.environment }})..."
          echo "ğŸ“‹ Deployment details:"
          echo "   - Environment: ${{ github.event.inputs.environment }}"
          echo "   - Triggered by: ${{ github.actor }}"
          echo "   - Deploy notes: ${{ github.event.inputs.deploy_notes || 'No notes provided' }}"
          echo "   - Build: Next.js optimized build"
          echo ""

      - name: Debug - Check secrets availability
        run: |
          echo "ğŸ” Checking Vercel secrets..."
          echo "VERCEL_TOKEN exists: ${{ secrets.VERCEL_TOKEN != '' && 'YES' || 'NO' }}"
          echo "ORG_ID exists: ${{ secrets.ORG_ID != '' && 'YES' || 'NO' }}"
          echo "PROJECT_ID exists: ${{ secrets.PROJECT_ID != '' && 'YES' || 'NO' }}"
          echo "Environment: ${{ github.event.inputs.environment }}"

      - name: Execute Vercel deployment
        id: vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: ${{ github.event.inputs.environment == 'production' && '--prod' || '--staging' }}
          working-directory: ./
          # GitHub ì½”ë©˜íŠ¸ ê¸°ëŠ¥ ë¹„í™œì„±í™” (ê¶Œí•œ ë¬¸ì œ í•´ê²°)
          github-comment: false

      - name: Deployment complete
        run: |
          echo "âœ… Deployment to ${{ github.event.inputs.environment }} completed successfully!"
          echo "ğŸŒ Your application is now live!"
          echo "ğŸ“Š Check deployment status at: https://vercel.com/dashboard"
          echo ""
          echo "ğŸ“ Deploy notes: ${{ github.event.inputs.deploy_notes || 'No notes provided' }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "â° Deployed at: $(date)"
          echo ""
          # Vercelì—ì„œ ìƒì„±ëœ URL í‘œì‹œ (ì•¡ì…˜ outputì—ì„œ ê°€ì ¸ì˜´)
          if [ "${{ steps.vercel.outputs.preview-url }}" ]; then
            echo "ğŸ”— Preview URL: ${{ steps.vercel.outputs.preview-url }}"
          fi
          echo "ğŸ”— Check Vercel dashboard for production URL"

      - name: Notify deployment result
        if: always() # ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ì‹¤í–‰
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Deployment successful!"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ” Check the logs above for error details"
            exit 1
          fi
